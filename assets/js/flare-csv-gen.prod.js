"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],a=!0,r=!1,o=void 0;try{for(var c,i=e[Symbol.iterator]();!(a=(c=i.next()).done)&&(n.push(c.value),!t||n.length!==t);a=!0);}catch(e){r=!0,o=e}finally{try{a||null==i.return||i.return()}finally{if(r)throw o}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}var colorModeBtn=document.querySelector(".mode-btn");colorModeBtn.addEventListener("change",function(){1==colorModeBtn.checked?(document.body.classList.remove("light-theme"),document.body.classList.add("dark-theme")):(document.body.classList.remove("dark-theme"),document.body.classList.add("light-theme"))}),1==window.matchMedia("(prefers-color-scheme: light)").matches&&colorModeBtn.click();var generate=document.getElementById("generate"),dataTable=document.getElementById("transaction-data"),loading=document.getElementById("loading"),loadingPercent=document.getElementById("loading-percent"),progressBar=document.querySelector("#loading .progress-bar"),dlbtn=document.getElementById("download"),dlbtnM=document.getElementById("download-more"),inputWaddress=document.getElementById("waddress"),inputStartDate=document.getElementById("starttimestamp"),inputEndDate=document.getElementById("endtimestamp"),clearStartDate=document.getElementById("clearStartDate"),clearEndDate=document.getElementById("clearEndDate"),numFLR=document.getElementById("num-flr"),numWFLR=document.getElementById("num-wflr"),numTx=document.getElementById("num-tx"),numTt=document.getElementById("num-tt"),numBl=document.getElementById("num-bl"),connectWalletBtn=document.getElementById("connect-wallet"),allTx=[],blockNumArr=[],waddress="",starttimestamp="",startUnixtime="",endtimestamp="",endUnixtime="",delayMS=50,delayCount=20,minDate="2023-01-10",csvSort=["Timestamp","Action","Source","Base","Volume","Price","Counter","Fee","FeeCcy","Comment"],csvSortMore=["Timestamp","Method","Source","Base","Volume","Counter","Fee","FeeCcy","hash","gas","gasPrice","gasUsed","priceAverage","FeeJPY","VolumeJPY"],methodId={Claim:["0xb2c12192","0xb2af870a"],AutoClaim:["0x6a761202","0x8dc305fa"],logOhterClaim:["0x6ec68517"],logAutoClaim:["0xddf252ad"],BatchDelegate:["0xdc4fcda7"],Delegate:["0x026e402b"],UndelegateAll:["0xb302f393"],SetAutoClaiming:["0xe72dcdbb"],EnableDelegationAccount:["0xf0977215"],Deposit:["0xd0e30db0"],CastVote:["0x56781388"],Withdraw:["0x2e1a7d4d"],SetClaimExecutors:["0x9119c494"],MultiTransfer:["0x1e89d545","0x7fb7e3f8"],Transfer:["0x"]},actions=["BUY","SELL","PAY","MINING","SENDFEE","REDUCE","BONUS","LENDING","STAKING","CASH","BORROW","RETURN","LOSS"],flareApi="https://flare-explorer.flare.network/api",bbPriceUrl="https://public.bitbank.cc/flr_jpy/candlestick/1min/",caddressWFLR="0x1D80c49BbBCd1C0911346656B529DF9E5c2F783d";function startDate(){inputStartDate.value?inputEndDate.min=inputStartDate.value:inputEndDate.min=minDate}function endDate(){inputEndDate.value?inputStartDate.max=inputEndDate.value:inputStartDate.max=""}function start(){allTx=[],blockNumArr=[],endtimestamp=starttimestamp=waddress="",waddress=inputWaddress.value;var e=inputStartDate.value,t=inputEndDate.value;if(e&&(startUnixtime=convertToUnixTime(e),starttimestamp="&starttimestamp="+startUnixtime),t&&(endUnixtime=convertToUnixTime(t)+86400,endtimestamp="&endtimestamp="+endUnixtime),42==waddress.length){for(;dataTable.firstChild;)dataTable.removeChild(dataTable.firstChild);numFLR.textContent="0",numWFLR.textContent="0",numTx.textContent="0",numTt.textContent="0",numBl.textContent="0",generate.classList.add("btn-secondary"),generate.classList.remove("btn-warning"),generate.classList.add("disabled"),clearStartDate.classList.add("btn-secondary"),clearStartDate.classList.remove("btn-warning"),clearStartDate.classList.add("disabled"),clearEndDate.classList.add("btn-secondary"),clearEndDate.classList.remove("btn-warning"),clearEndDate.classList.add("disabled"),dlbtnM.classList.add("btn-secondary"),dlbtnM.classList.remove("btn-warning"),dlbtnM.classList.add("disabled"),dlbtn.classList.add("btn-secondary"),dlbtn.classList.remove("btn-warning"),dlbtn.classList.add("disabled"),loading.classList.remove("pre-load"),getTx(waddress,allTx,blockNumArr)}else alert("Wrong address length.\nCheck wallet address.")}function getTx(n,a,r){fetch("".concat(flareApi,"?module=account&action=txlist&address=").concat(n).concat(starttimestamp).concat(endtimestamp)).then(function(e){return e.json()}).then(function(e){var t=e.result;t.forEach(function(e){e.dataSource="transactions",a.push(e),r.push(e.blockNumber)}),numTx.textContent=t.length,getTt(n,a,r)}),fetch("".concat(flareApi,"?module=account&action=balance&address=").concat(n)).then(function(e){return e.json()}).then(function(e){var t=e.result;numFLR.textContent=division10p18fixed9(t)}),fetch("".concat(flareApi,"?module=account&action=tokenbalance&contractaddress=").concat(caddressWFLR,"&address=").concat(n)).then(function(e){return e.json()}).then(function(e){var t=e.result;numWFLR.textContent=division10p18fixed9(t)})}function getTt(e,n,a){fetch("".concat(flareApi,"?module=account&action=tokentx&address=").concat(e).concat(starttimestamp).concat(endtimestamp)).then(function(e){return e.json()}).then(function(e){var t=0;if(e.result.forEach(function(e){timeJudge(e.timeStamp,startUnixtime,endUnixtime)&&(-1!==a.indexOf(e.blockNumber)||"FLR"!=e.tokenSymbol&&"WFLR"!=e.tokenSymbol||(n.push(e),a.push(e.blockNumber)),t++)}),numTt.textContent=t,numBl.textContent=a.length,!n.length)return alert("No Transactions."),loading.classList.add("pre-load"),!1;allTxAjust(n)})}function allTxAjust(e){e.sort(function(e,t){return e.blockNumber-t.blockNumber}),e.forEach(function(n){var e=new Date(1e3*n.timeStamp);n.Timestamp=convertToJapanDateTime(e,"YMDHMS"),n.unixtimeSec=e.setSeconds(0),n.ymd=convertToJapanDateTime(n.unixtimeSec,"YMD"),n.Source="flare.network",n.Base="FLR",n.Volume=0,n.Price="",n.Counter="JPY",n.FeeCcy="FLR",n.Comment=n.hash,n.candlesticks={},n.priceAverage=0,n.Fee=division10p18fixed9(n.gasPrice*n.gasUsed),n.Method="UNKNOWN",n.methodId=n.input.slice(0,10),n.logs=[];for(var a=0,r=Object.entries(methodId);a<r.length;a++)!function(){var e=_slicedToArray(r[a],2),t=e[0];e[1].forEach(function(e){n.methodId==e&&(n.Method=t)})}()}),getLogsPrice(e)}function getLogsPrice(n){var a=0,r=n.length;!function t(){var e;a===r?dlBtnActive():(e=n[a].hash,fetch("".concat(flareApi,"?module=transaction&action=gettxinfo&txhash=").concat(e)).then(function(e){return e.json()}).then(function(e){n[a].logs=e.result.logs,n[a].dataSource,fetch("".concat(bbPriceUrl).concat(n[a].ymd)).then(function(e){return e.json()}).then(function(e){1==e.success&&e.data.candlestick[0].ohlcv.forEach(function(e){e[5]==n[a].unixtimeSec&&(n[a].candlesticks=e,n[a].priceAverage=Number(((Number(e[0])+Number(e[1])+Number(e[2])+Number(e[3]))/4).toFixed(9)))}),tableRender(n[a]),progress(++a,blockNumArr.length),setTimeout(t,delayMS)})}))}()}function tableRender(n){switch(n.Method){case"Claim":n.logs[0]&&n.logs.forEach(function(e){var t=e.topics[0].slice(0,10);-1!==methodId.logAutoClaim.indexOf(t)&&(n.Volume=division10p18fixed9(hexConvert(e.data))),-1!==methodId.logOhterClaim.indexOf(t)&&(n.Volume=n.Volume+division10p18fixed9(hexConvert(e.data.slice(e.data.length-64))))});break;case"SetAutoClaiming":n.Fee=n.Fee+division10p18fixed9(n.value);break;case"AutoClaim":n.Volume=division10p18fixed9(n.value);break;case"Withdraw":n.Volume=division10p18fixed9(hexConvert(n.input.slice(n.input.length-16)));break;case"Deposit":n.Volume=division10p18fixed9(n.value);break;case"Transfer":n.Volume=division10p18fixed9(n.value),waddress.toUpperCase()==n.from.toUpperCase()?(n.Volume=-n.Volume,n.Action="PAY"):(n.Action="BONUS",n.Fee=0)}switch(n.Method){case"Claim":case"AutoClaim":n.Action="MINING";break;case"BatchDelegate":case"Delegate":case"UndelegateAll":case"SetAutoClaiming":case"EnableDelegationAccount":case"CastVote":case"SetClaimExecutors":case"Withdraw":case"Deposit":n.Action="SENDFEE";break;case"UNKNOWN":n.Action="CASH"}var e=document.createElement("tr"),t=document.createElement("th");t.classList.add("text-start"),t.innerHTML=n.Timestamp;var a=document.createElement("td");switch(a.innerHTML=n.Method,a.classList.add("text-center"),n.Method){case"BatchDelegate":case"Delegate":a.classList.add("bg-primary"),a.classList.add("text-white");break;case"Claim":case"AutoClaim":a.classList.add("bg-warning"),a.classList.add("text-dark");break;case"Deposit":a.classList.add("bg-success"),a.classList.add("text-white"),a.insertAdjacentText("beforeend"," (Wrapped)");break;case"Withdraw":a.classList.add("bg-success"),a.classList.add("text-white"),a.insertAdjacentText("beforeend"," (Unwrapped)");break;default:a.classList.add("bg-light"),a.classList.add("text-dark")}var r=document.createElement("td"),o=document.createElement("select");o.classList.add("form-select"),actions.forEach(function(e){var t=document.createElement("option");t.value=e,(t.text=e)==n.Action&&(t.selected=!0),o.appendChild(t)}),o.addEventListener("change",function(){n.Action=this.value}),r.appendChild(o);var c=document.createElement("td");c.classList.add("text-start");var i=document.createElement("span");i.classList.add("material-symbols-outlined"),i.innerHTML="link";var s=document.createElement("a");s.href="https://flare-explorer.flare.network/tx/"+n.hash,s.target="_blank",s.appendChild(i),s.appendChild(document.createTextNode(n.hash)),c.appendChild(s);var d=document.createElement("td");d.innerHTML=n.Volume;var l=document.createElement("td");l.innerHTML=n.Fee;var u=document.createElement("td");u.innerHTML=n.priceAverage;var m=document.createElement("td");n.FeeJPY=(n.Fee*n.priceAverage).toFixed(9),m.innerHTML=n.FeeJPY;var p=document.createElement("td");n.VolumeJPY=(n.Volume*n.priceAverage).toFixed(9),0!=n.VolumeJPY&&"Withdraw"!=n.Method&&"Deposit"!=n.Method||(n.VolumeJPY=0),p.innerHTML=n.VolumeJPY,e.appendChild(t),e.appendChild(a),e.appendChild(r),e.appendChild(c),e.appendChild(d),e.appendChild(l),e.appendChild(u),e.appendChild(m),e.appendChild(p),dataTable.prepend(e)}function timeJudge(e,t,n){return!t&&!n||(!!(t&&!n&&t<=e)||(!!(!t&&n&&e<=n)||!!(t&&n&&t<=e&&e<=n)))}function progress(e,t){var n=Math.ceil(e/t*100),a=n+"%";progressBar.setAttribute("aria-valuenow",n),progressBar.style.width=a,loadingPercent.innerHTML="100%"==a?"Complete.":a}function dlBtnActive(){dlbtnM.classList.remove("btn-secondary"),dlbtnM.classList.add("btn-warning"),dlbtnM.classList.remove("disabled"),dlbtn.classList.remove("btn-secondary"),dlbtn.classList.add("btn-warning"),dlbtn.classList.remove("disabled"),setTimeout(function(){loading.classList.add("pre-load"),generate.classList.remove("btn-secondary"),generate.classList.add("btn-warning"),generate.classList.remove("disabled"),clearStartDate.classList.remove("btn-secondary"),clearStartDate.classList.add("btn-warning"),clearStartDate.classList.remove("disabled"),clearEndDate.classList.remove("btn-secondary"),clearEndDate.classList.add("btn-warning"),clearEndDate.classList.remove("disabled")},1e3),setTimeout(function(){progressBar.setAttribute("aria-valuenow","0"),progressBar.style.width="0%",loadingPercent.innerHTML="0%"},1500)}function downloadCSVforCT(){var e=JSON.parse(JSON.stringify(allTx)),a=[];e.forEach(function(t){var n={};csvSort.forEach(function(e){t.hasOwnProperty(e)&&(n[e]=t[e])}),a.push(n)}),csvDownload(a,"flr-csv-for-cryptact.csv")}function downloadCSVMore(){var e=JSON.parse(JSON.stringify(allTx)),a=[];e.forEach(function(t){var n={};csvSortMore.forEach(function(e){t.hasOwnProperty(e)&&(n[e]=t[e])}),a.push(n)}),csvDownload(a,"flr-csv-more.csv")}function csvDownload(e,t){var n=Object.keys(e[0]).join(",")+"\n"+e.map(function(e){return Object.values(e).join(",")}).join("\n"),a=new Blob([n],{type:"text/csv"}),r=document.createElement("a");r.href=URL.createObjectURL(a),r.download=t,r.click(),r.remove()}function division10p18fixed9(e){var t=Number((e/1e9).toFixed(9));return Number((t/1e9).toFixed(9))}function convertToJapanDateTime(e,t){var n=new Date(e);"YMDHMS"==t?n.setHours(n.getHours()):"YMD"==t&&n.setHours(n.getHours()-9);var a=n.getFullYear(),r=(n.getMonth()+1).toString().padStart(2,"0"),o=n.getDate().toString().padStart(2,"0"),c=n.getHours().toString().padStart(2,"0"),i=n.getMinutes().toString().padStart(2,"0"),s=("0"+n.getSeconds()).slice(-2);return"YMDHMS"==t?"".concat(a,"-").concat(r,"-").concat(o," ").concat(c,":").concat(i,":").concat(s):"YMD"==t?"".concat(a).concat(r).concat(o):void 0}function hexConvert(e){return parseInt(e,16)}function convertToUnixTime(e){return Math.floor(new Date(e).getTime()/1e3)}inputStartDate.addEventListener("change",function(){startDate()}),clearStartDate.addEventListener("click",function(){inputStartDate.value="",startDate()}),inputEndDate.addEventListener("change",function(){endDate()}),clearEndDate.addEventListener("click",function(){inputEndDate.value="",endDate()}),window.addEventListener("load",function(){var a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:a=new Web3(window.ethereum),connectWalletBtn.addEventListener("click",function(){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===window.ethereum)return alert("MetaMask is not installed!"),e.abrupt("return");e.next=3;break;case 3:return e.prev=3,e.next=6,regeneratorRuntime.awrap(window.ethereum.request({method:"eth_requestAccounts"}));case 6:return e.next=8,regeneratorRuntime.awrap(a.eth.getAccounts());case 8:t=e.sent,n=t[0],inputWaddress.value=n,e.next=17;break;case 13:e.prev=13,e.t0=e.catch(3),alert("Failed to connect to wallet"),console.error(e.t0);case 17:case"end":return e.stop()}},null,null,[[3,13]])});case 2:case"end":return e.stop()}})});