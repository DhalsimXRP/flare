const colorModeBtn=document.querySelector(".mode-btn"),generate=(colorModeBtn.addEventListener("change",()=>{1==colorModeBtn.checked?(document.body.classList.remove("light-theme"),document.body.classList.add("dark-theme")):(document.body.classList.remove("dark-theme"),document.body.classList.add("light-theme"))}),1==window.matchMedia("(prefers-color-scheme: light)").matches&&colorModeBtn.click(),document.getElementById("generate")),dataTable=document.getElementById("transaction-data"),loading=document.getElementById("loading"),loadingPercent=document.getElementById("loading-percent"),progressBar=document.querySelector("#loading .progress-bar"),dlbtn=document.getElementById("download"),dlbtnM=document.getElementById("download-more"),inputWaddress=document.getElementById("waddress"),inputStartDate=document.getElementById("startTimestamp"),inputEndDate=document.getElementById("endTimestamp"),clearStartDate=document.getElementById("clearStartDate"),clearEndDate=document.getElementById("clearEndDate"),numFLR=document.getElementById("num-flr"),numWFLR=document.getElementById("num-wflr"),numTx=document.getElementById("num-tx"),numTt=document.getElementById("num-tt"),numBl=document.getElementById("num-bl"),connectWalletBtn=document.getElementById("connect-wallet");let allTx=[],blockNumArr=[],waddress,startTimestamp,endTimestamp;const delayMS=50,delayCount=20,minDate="2023-01-10",csvSort=["Timestamp","Action","Source","Base","Volume","Price","Counter","Fee","FeeCcy","Comment"],csvSortMore=["Timestamp","Method","Source","Base","Volume","Counter","Fee","FeeCcy","hash","gas","gasPrice","gasUsed","priceAverage","FeeJPY","VolumeJPY"],methodId={Claim:["0xb2c12192","0xb2af870a"],AutoClaim:["0x6a761202","0x8dc305fa"],logClaim:["0x0aa4d283"],logAutoClaim:["0xddf252ad"],logOhterClaim:["0x6ec68517"],BatchDelegate:["0xdc4fcda7"],Delegate:["0x026e402b"],UndelegateAll:["0xb302f393"],SetAutoClaiming:["0xe72dcdbb"],EnableDelegationAccount:["0xf0977215"],Deposit:["0xd0e30db0"],CastVote:["0x56781388"],Withdraw:["0x2e1a7d4d"],SetClaimExecutors:["0x9119c494"],MultiTransfer:["0x1e89d545","0x7fb7e3f8"],RegisterAddresses:["0x5b75d79c"],Transfer:["0x"]},actions=["BUY","SELL","PAY","MINING","SENDFEE","REDUCE","BONUS","LENDING","STAKING","CASH","BORROW","RETURN","LOSS"],flareApi="https://flare-explorer.flare.network/api",bbPriceUrl="https://public.bitbank.cc/flr_jpy/candlestick/1min/",caddressWFLR="0x1D80c49BbBCd1C0911346656B529DF9E5c2F783d";function startDate(){inputStartDate.value?inputEndDate.min=inputStartDate.value:inputEndDate.min=minDate}function endDate(){inputEndDate.value?inputStartDate.max=inputEndDate.value:inputStartDate.max=""}function start(){allTx=[],targetTx=[],blockNumArr=[],waddress,startTimestamp,endTimestamp,waddress=inputWaddress.value;var e=inputStartDate.value,t=inputEndDate.value;if(e&&(startTimestamp=convertToUnixTime(e)),t&&(endTimestamp=convertToUnixTime(t)+86400),42==waddress.length){for(;dataTable.firstChild;)dataTable.removeChild(dataTable.firstChild);numFLR.textContent="0",numWFLR.textContent="0",numTx.textContent="0",numTt.textContent="0",numBl.textContent="0",generate.classList.add("btn-secondary"),generate.classList.remove("btn-warning"),generate.classList.add("disabled"),clearStartDate.classList.add("btn-secondary"),clearStartDate.classList.remove("btn-warning"),clearStartDate.classList.add("disabled"),clearEndDate.classList.add("btn-secondary"),clearEndDate.classList.remove("btn-warning"),clearEndDate.classList.add("disabled"),dlbtnM.classList.add("btn-secondary"),dlbtnM.classList.remove("btn-warning"),dlbtnM.classList.add("disabled"),dlbtn.classList.add("btn-secondary"),dlbtn.classList.remove("btn-warning"),dlbtn.classList.add("disabled"),loading.classList.remove("pre-load"),getTx(waddress,allTx,blockNumArr)}else alert("Wrong address length.\nCheck wallet address.")}function getTx(d,r,i){fetch(flareApi+"?module=account&action=txlist&address="+d).then(e=>e.json()).then(e=>{let t=0;var a=e.result;for(let e=0;e<a.length;e++){var n=a[e],s=(n.timeStamp=Number(n.timeStamp),timeJudge(n.timeStamp,startTimestamp,endTimestamp));s&&(n.dataSource="transactions",r.push(n),i.push(n.blockNumber),t++)}numTx.textContent=t,getTt(d,r,i)}),fetch(flareApi+"?module=account&action=balance&address="+d).then(e=>e.json()).then(e=>{e=e.result;numFLR.textContent=division10p18fixed9(e)}),fetch(`${flareApi}?module=account&action=tokenbalance&contractaddress=${caddressWFLR}&address=`+d).then(e=>e.json()).then(e=>{e=e.result;numWFLR.textContent=division10p18fixed9(e)})}function getTt(e,d,r){fetch(flareApi+"?module=account&action=tokentx&address="+e).then(e=>e.json()).then(e=>{let t=0;var a=e.result;for(let e=0;e<a.length;e++){var n=a[e],s=(n.timeStamp=Number(n.timeStamp),timeJudge(n.timeStamp,startTimestamp,endTimestamp));s&&(-1!==r.indexOf(n.blockNumber)||"FLR"!=n.tokenSymbol&&"WFLR"!=n.tokenSymbol||(d.push(n),r.push(n.blockNumber)),t++)}if(numTt.textContent=t,numBl.textContent=r.length,!d.length)return alert("No Transactions."),loading.classList.add("pre-load"),!1;allTxAjust(d)})}function allTxAjust(t){t.sort(function(e,t){return e.blockNumber-t.blockNumber});for(let e=0;e<t.length;e++){const n=t[e];var a=new Date(1e3*n.timeStamp);n.Timestamp=convertToJapanDateTime(a,"YMDHMS"),n.unixtimeSec=a.setSeconds(0),n.ymd=convertToJapanDateTime(n.unixtimeSec,"YMD"),n.Source="flare.network",n.Base="FLR",n.Volume=0,n.Price="",n.Counter="JPY",n.FeeCcy="FLR",n.Comment=n.hash,n.candlesticks={},n.priceAverage=0,n.Fee=division10p18fixed9(n.gasPrice*n.gasUsed),n.Method="UNKNOWN",n.methodId=n.input.slice(0,10),n.logs=[];for(const[s,d]of Object.entries(methodId))d.forEach(e=>{n.methodId==e&&(n.Method=s)})}getLogsPrice(t)}function getLogsPrice(a){let n=0;const s=a.length;!function t(){var e;n===s?dlBtnActive():(e=a[n].hash,fetch(flareApi+"?module=transaction&action=gettxinfo&txhash="+e).then(e=>e.json()).then(e=>{a[n].logs=e.result.logs,a[n].dataSource,fetch(""+bbPriceUrl+a[n].ymd).then(e=>e.json()).then(e=>{1==e.success&&e.data.candlestick[0].ohlcv.forEach(e=>{e[5]==a[n].unixtimeSec&&(a[n].candlesticks=e,a[n].priceAverage=Number(((Number(e[0])+Number(e[1])+Number(e[2])+Number(e[3]))/4).toFixed(9)))}),tableRender(a[n]),progress(++n,blockNumArr.length),setTimeout(t,delayMS)})}))}()}function tableRender(a){switch(a.Method){case"Claim":a.logs[0]&&a.logs.forEach(e=>{var t=e.topics[0].slice(0,10);-1!==methodId.logClaim.indexOf(t)&&(a.Volume=division10p18fixed9(hexConvert(e.data))),-1!==methodId.logAutoClaim.indexOf(t)&&(a.Volume=division10p18fixed9(hexConvert(e.data))),-1!==methodId.logOhterClaim.indexOf(t)&&(a.Volume=a.Volume+division10p18fixed9(hexConvert(e.data.slice(e.data.length-64))))});break;case"SetAutoClaiming":a.Fee=a.Fee+division10p18fixed9(a.value);break;case"AutoClaim":a.Volume=division10p18fixed9(a.value);break;case"Withdraw":a.Volume=division10p18fixed9(hexConvert(a.input.slice(a.input.length-16)));break;case"Deposit":a.Volume=division10p18fixed9(a.value);break;case"Transfer":a.Volume=division10p18fixed9(a.value),waddress.toUpperCase()==a.from.toUpperCase()?(a.Volume=-a.Volume,a.Action="PAY"):(a.Action="BONUS",a.Fee=0)}switch(a.Method){case"Claim":case"AutoClaim":a.Action="MINING";break;case"BatchDelegate":case"Delegate":case"UndelegateAll":case"SetAutoClaiming":case"EnableDelegationAccount":case"Deposit":case"CastVote":case"Withdraw":case"SetClaimExecutors":case"MultiTransfer":case"RegisterAddresses":a.Action="SENDFEE";break;case"UNKNOWN":a.Action="CASH"}var e=document.createElement("tr"),t=document.createElement("th"),n=(t.classList.add("text-start"),t.innerHTML=a.Timestamp,document.createElement("td"));switch(n.innerHTML=a.Method,n.classList.add("text-center"),a.Method){case"BatchDelegate":case"Delegate":n.classList.add("bg-primary"),n.classList.add("text-white");break;case"Claim":case"AutoClaim":n.classList.add("bg-warning"),n.classList.add("text-dark");break;case"Deposit":n.classList.add("bg-success"),n.classList.add("text-white"),n.insertAdjacentText("beforeend"," (Wrapped)");break;case"Withdraw":n.classList.add("bg-success"),n.classList.add("text-white"),n.insertAdjacentText("beforeend"," (Unwrapped)");break;default:n.classList.add("bg-light"),n.classList.add("text-dark")}var s=document.createElement("td");let d=document.createElement("select");d.classList.add("form-select"),actions.forEach(e=>{var t=document.createElement("option");t.value=e,(t.text=e)==a.Action&&(t.selected=!0),d.appendChild(t)}),d.addEventListener("change",function(){a.Action=this.value}),s.appendChild(d);var r=document.createElement("td"),i=(r.classList.add("text-start"),document.createElement("span")),o=(i.classList.add("material-symbols-outlined"),i.innerHTML="link",document.createElement("a")),i=(o.href="https://flare-explorer.flare.network/tx/"+a.hash,o.target="_blank",o.appendChild(i),o.appendChild(document.createTextNode(a.hash)),r.appendChild(o),document.createElement("td")),o=(i.innerHTML=a.Volume,document.createElement("td")),l=(o.innerHTML=a.Fee,document.createElement("td")),c=(l.innerHTML=a.priceAverage,document.createElement("td")),m=(a.FeeJPY=(a.Fee*a.priceAverage).toFixed(9),c.innerHTML=a.FeeJPY,document.createElement("td"));a.VolumeJPY=(a.Volume*a.priceAverage).toFixed(9),0!=a.VolumeJPY&&"Withdraw"!=a.Method&&"Deposit"!=a.Method||(a.VolumeJPY=0),m.innerHTML=a.VolumeJPY,e.appendChild(t),e.appendChild(n),e.appendChild(s),e.appendChild(r),e.appendChild(i),e.appendChild(o),e.appendChild(l),e.appendChild(c),e.appendChild(m),dataTable.prepend(e)}function timeJudge(e,t,a){return!t&&!a||!!(t&&!a&&t<=e)||!!(!t&&a&&e<=a)||!!(t&&a&&t<=e&&e<=a)}function progress(e,t){e=Math.ceil(e/t*100),t=e+"%";progressBar.setAttribute("aria-valuenow",e),progressBar.style.width=t,loadingPercent.innerHTML="100%"==t?"Complete.":t}function dlBtnActive(){dlbtnM.classList.remove("btn-secondary"),dlbtnM.classList.add("btn-warning"),dlbtnM.classList.remove("disabled"),dlbtn.classList.remove("btn-secondary"),dlbtn.classList.add("btn-warning"),dlbtn.classList.remove("disabled"),setTimeout(()=>{loading.classList.add("pre-load"),generate.classList.remove("btn-secondary"),generate.classList.add("btn-warning"),generate.classList.remove("disabled"),clearStartDate.classList.remove("btn-secondary"),clearStartDate.classList.add("btn-warning"),clearStartDate.classList.remove("disabled"),clearEndDate.classList.remove("btn-secondary"),clearEndDate.classList.add("btn-warning"),clearEndDate.classList.remove("disabled")},1e3),setTimeout(()=>{progressBar.setAttribute("aria-valuenow","0"),progressBar.style.width="0%",loadingPercent.innerHTML="0%"},1500)}function downloadCSVforCT(){var e=JSON.parse(JSON.stringify(allTx));let n=[];e.forEach(t=>{const a={};csvSort.forEach(e=>{t.hasOwnProperty(e)&&(a[e]=t[e])}),n.push(a)}),csvDownload(n,"flr-csv-for-cryptact.csv")}function downloadCSVMore(){var e=JSON.parse(JSON.stringify(allTx));let n=[];e.forEach(t=>{const a={};csvSortMore.forEach(e=>{t.hasOwnProperty(e)&&(a[e]=t[e])}),n.push(a)}),csvDownload(n,"flr-csv-more.csv")}function csvDownload(e,t){var e=Object.keys(e[0]).join(",")+"\n"+e.map(e=>Object.values(e).join(",")).join("\n"),e=new Blob([e],{type:"text/csv"}),a=document.createElement("a");a.href=URL.createObjectURL(e),a.download=t,a.click(),a.remove()}function division10p18fixed9(e){e=Number((e/1e9).toFixed(9));return Number((e/1e9).toFixed(9))}function convertToJapanDateTime(e,t){var e=new Date(e),a=("YMDHMS"==t?e.setHours(e.getHours()):"YMD"==t&&e.setHours(e.getHours()-9),e.getFullYear()),n=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getDate().toString().padStart(2,"0"),d=e.getHours().toString().padStart(2,"0"),r=e.getMinutes().toString().padStart(2,"0"),e=("0"+e.getSeconds()).slice(-2);return"YMDHMS"==t?a+`-${n}-${s} ${d}:${r}:`+e:"YMD"==t?""+a+n+s:void 0}function hexConvert(e){return parseInt(e,16)}function convertToUnixTime(e){return Math.floor(new Date(e).getTime()/1e3)}inputStartDate.addEventListener("change",()=>{startDate()}),clearStartDate.addEventListener("click",()=>{inputStartDate.value="",startDate()}),inputEndDate.addEventListener("change",()=>{endDate()}),clearEndDate.addEventListener("click",()=>{inputEndDate.value="",endDate()}),window.addEventListener("load",async()=>{const t=new Web3(window.ethereum);connectWalletBtn.addEventListener("click",async()=>{if(void 0===window.ethereum)alert("MetaMask is not installed!");else try{await window.ethereum.request({method:"eth_requestAccounts"});var e=(await t.eth.getAccounts())[0];inputWaddress.value=e}catch(e){alert("Failed to connect to wallet")}})});