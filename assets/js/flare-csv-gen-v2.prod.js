const colorModeBtn=document.querySelector(".mode-btn");colorModeBtn.addEventListener("change",(()=>{1==colorModeBtn.checked?(document.body.classList.remove("light-theme"),document.body.classList.add("dark-theme")):(document.body.classList.remove("dark-theme"),document.body.classList.add("light-theme"))})),1==window.matchMedia("(prefers-color-scheme: light)").matches&&colorModeBtn.click();const generate=document.getElementById("generate"),dataTable=document.getElementById("transaction-data"),loading=document.getElementById("loading"),loadingPercent=document.getElementById("loading-percent"),progressBar=document.querySelector("#loading .progress-bar"),dlbtn=document.getElementById("download"),dlbtnM=document.getElementById("download-more"),inputWaddress=document.getElementById("waddress"),inputStartDate=document.getElementById("startTimestamp"),inputEndDate=document.getElementById("endTimestamp"),clearStartDate=document.getElementById("clearStartDate"),clearEndDate=document.getElementById("clearEndDate"),numFLR=document.getElementById("num-flr"),numWFLR=document.getElementById("num-wflr"),numTx=document.getElementById("num-tx"),numTt=document.getElementById("num-tt"),connectWalletBtn=document.getElementById("connect-wallet");let waddress,startTimestamp,endTimestamp,targetTx=[];const delayMS=50,delayCount=20,minDate="2023-01-10",csvSort=["Timestamp","Action","Source","Base","Volume","Price","Counter","Fee","FeeCcy","Comment"],csvSortMore=["Timestamp","Method","Source","Base","Volume","Counter","Fee","FeeCcy","hash","gas","gasPrice","gasUsed","priceAverage","FeeJPY","VolumeJPY"],methodId={claim:["0xb2af870a","0x25181bb0","0x379607f5"],claimWFLR:["0xb2c12192","0x25181bb","0x8e33aba5"],AutoClaim:["0x6a761202","0x8dc305fa","0x15f253fb"],claimRewards:["0xef5cfb8c","0xb88a802f"],claimAllRewards:["0x0b83a727"],logAutoClaim:["0xddf252ad"],logOhterClaim:["0x6ec68517"],BatchDelegate:["0xdc4fcda7"],Delegate:["0x026e402b"],UndelegateAll:["0xb302f393"],SetAutoClaiming:["0xe72dcdbb"],EnableDelegationAccount:["0xf0977215"],Deposit:["0xd0e30db0"],depositToken:["0x6215be77"],CastVote:["0x56781388"],Withdraw:["0x2e1a7d4d"],SetClaimExecutors:["0x9119c494"],MultiTransfer:["0x1e89d545","0x7fb7e3f8"],RegisterAddresses:["0x5b75d79c"],approve:["0x095ea7b3"],onBoardUser:["0x4a9833b5"],mintNFT:["0x92642744"],mint:["0xa0712d68"],mintWhiteList:["0xb4993152"],setApprovalForAll:["0xa22cb465"],logClaim:["0x0aa4d283"],Transfer:["0x","0xa9059cbb","0xdd711067"],swap:["0x2b3b0f2b","0xbc10490c","0xbc10490c"],addLiquidityFLR:["0x9943d8f3"],removeLiquidityFLR:["0x20d88f9a"],stake:["0xa694fc3a"]},actions=["BUY","SELL","PAY","MINING","SENDFEE","REDUCE","BONUS","LENDING","STAKING","CASH","BORROW","RETURN","LOSS"],flareApi="https://flare-explorer.flare.network/api",caddressWFLR="0x1D80c49BbBCd1C0911346656B529DF9E5c2F783d",bbPriceUrl="https://public.bitbank.cc/flr_jpy/candlestick/1min/";function startDate(){inputStartDate.value?inputEndDate.min=inputStartDate.value:inputEndDate.min=minDate}function endDate(){inputEndDate.value?inputStartDate.max=inputEndDate.value:inputStartDate.max=""}function start(){waddress="",startTimestamp="",endTimestamp="",targetTx=[],waddress=inputWaddress.value;let e=inputStartDate.value,t=inputEndDate.value;if(e&&(startTimestamp=convertToUnixTime(e)),t&&(endTimestamp=convertToUnixTime(t)+86400),42==waddress.length){for(;dataTable.firstChild;)dataTable.removeChild(dataTable.firstChild);numFLR.textContent="0",numWFLR.textContent="0",numTx.textContent="0",numTt.textContent="0",generate.classList.add("btn-secondary"),generate.classList.remove("btn-warning"),generate.classList.add("disabled"),clearStartDate.classList.add("btn-secondary"),clearStartDate.classList.remove("btn-warning"),clearStartDate.classList.add("disabled"),clearEndDate.classList.add("btn-secondary"),clearEndDate.classList.remove("btn-warning"),clearEndDate.classList.add("disabled"),dlbtnM.classList.add("btn-secondary"),dlbtnM.classList.remove("btn-warning"),dlbtnM.classList.add("disabled"),dlbtn.classList.add("btn-secondary"),dlbtn.classList.remove("btn-warning"),dlbtn.classList.add("disabled"),loading.classList.remove("pre-load"),getTx()}else alert("Wrong address length.\nCheck wallet address.")}function getTx(){fetch(`${flareApi}?module=account&action=balance&address=${waddress}`).then((e=>e.json())).then((e=>{const t=e.result;numFLR.textContent=division10p18fixed9(t)})),fetch(`${flareApi}?module=account&action=tokenbalance&contractaddress=${caddressWFLR}&address=${waddress}`).then((e=>e.json())).then((e=>{const t=e.result;numWFLR.textContent=division10p18fixed9(t)})),fetch(`${flareApi}?module=account&action=txlist&address=${waddress}`).then((e=>e.json())).then((e=>{let t=e.result;for(let e=0;e<t.length;e++){const a=t[e];a.timeStamp=Number(a.timeStamp),timeJudge(a.timeStamp,startTimestamp,endTimestamp)&&(a.dataSource="transactions",targetTx.push(a))}numTx.textContent=targetTx.length,fetch(`${flareApi}?module=account&action=tokentx&address=${waddress}`).then((e=>e.json())).then((e=>{let t=e.result,a=[],n=0;for(let e=0;e<t.length;e++){const s=t[e];s.timeStamp=Number(s.timeStamp),timeJudge(s.timeStamp,startTimestamp,endTimestamp)&&("WFLR"==s.tokenSymbol&&a.push(s),n++)}numTt.textContent=n,a.forEach((e=>{const t=targetTx.find((t=>t.blockNumber===e.blockNumber));t?(t.value=e.value,t.tokenName=e.tokenName,t.tokenSymbol=e.tokenSymbol):targetTx.push(e)})),targetTx.forEach((e=>{e.methodId=e.input.slice(0,10),e.Method="UNKNOWN";for(const[t,a]of Object.entries(methodId))a.forEach((a=>{e.methodId==a&&(e.Method=t)}))}));const s=targetTx.filter((e=>"claimWFLR"==e.Method)).map((e=>fetch(`${flareApi}?module=account&action=txlistinternal&txhash=${e.hash}`).then((e=>e.json())).then((t=>{e.value=0,t.result.forEach((t=>{e.value+=Number(t.value)}))}))));Promise.all(s).then((()=>{!function(){if(!targetTx.length)return alert("No Transactions."),loading.classList.add("pre-load"),!1;allTxAjust(targetTx)}()}))}))}))}function allTxAjust(e){e.sort((function(e,t){return e.blockNumber-t.blockNumber}));for(let t=0;t<e.length;t++){const a=e[t],n=new Date(1e3*a.timeStamp);a.Timestamp=convertToJapanDateTime(n,"YMDHMS"),a.unixtimeSec=n.setSeconds(0),a.ymd=convertToJapanDateTime(a.unixtimeSec,"YMD"),a.Source="flare.network",a.Base="FLR",a.Volume=0,a.Price="",a.Counter="JPY",a.FeeCcy="FLR",a.Comment=a.hash,a.candlesticks={},a.priceAverage=0,a.Fee=division10p18fixed9(a.gasPrice*a.gasUsed),a.logs=[]}getLogsPrice(e)}function getLogsPrice(e){let t=0;const a=e.length;!function n(){t===a?dlBtnActive():fetch(`${bbPriceUrl}${e[t].ymd}`).then((e=>e.json())).then((a=>{if(1==a.success){a.data.candlestick[0].ohlcv.forEach((a=>{a[5]==e[t].unixtimeSec&&(e[t].candlesticks=a,e[t].priceAverage=Number(((Number(a[0])+Number(a[1])+Number(a[2])+Number(a[3]))/4).toFixed(9)))}))}tableRender(e[t]),t++,progress(t,e.length),setTimeout(n,50)}))}()}function tableRender(e){switch(e.Method){case"SetAutoClaiming":e.Fee=e.Fee+division10p18fixed9(e.value);break;case"Withdraw":e.Volume=division10p18fixed9(hexConvert(e.input.slice(e.input.length-16)));break;case"Transfer":e.Volume=division10p18fixed9(e.value),waddress.toUpperCase()==e.from.toUpperCase()?(e.Volume=-e.Volume,e.Action="PAY"):(e.Action="BONUS",e.Fee=0);break;case"swap":case"addLiquidityFLR":case"removeLiquidityFLR":case"stake":e.Volume=0;break;default:e.Volume=division10p18fixed9(e.value)}switch(e.Method){case"claim":case"claimWFLR":case"AutoClaim":case"claimRewards":case"claimAllRewards":e.Action="MINING";break;case"logClaim":case"BatchDelegate":case"Delegate":case"UndelegateAll":case"SetAutoClaiming":case"EnableDelegationAccount":case"Deposit":case"depositToken":case"CastVote":case"Withdraw":case"SetClaimExecutors":case"MultiTransfer":case"RegisterAddresses":case"approve":case"onBoardUser":case"mintNFT":case"mint":case"mintWhiteList":case"setApprovalForAll":case"swap":case"addLiquidityFLR":case"removeLiquidityFLR":case"stake":e.Action="SENDFEE";break;case"UNKNOWN":e.Action="CASH"}const t=document.createElement("tr");let a=document.createElement("th");a.classList.add("text-start"),a.innerHTML=e.Timestamp;let n=document.createElement("td");switch(n.innerHTML=e.Method,n.classList.add("text-center"),e.Method){case"BatchDelegate":case"Delegate":n.classList.add("bg-primary"),n.classList.add("text-white");break;case"claim":case"claimWFLR":case"AutoClaim":n.classList.add("bg-warning"),n.classList.add("text-dark");break;case"Deposit":n.classList.add("bg-success"),n.classList.add("text-white"),n.insertAdjacentText("beforeend"," (Wrapped)");break;case"Withdraw":n.classList.add("bg-success"),n.classList.add("text-white"),n.insertAdjacentText("beforeend"," (Unwrapped)");break;default:n.classList.add("bg-light"),n.classList.add("text-dark")}let s=document.createElement("td"),d=document.createElement("select");d.classList.add("form-select"),actions.forEach((t=>{let a=document.createElement("option");a.value=t,a.text=t,t==e.Action&&(a.selected=!0),d.appendChild(a)})),d.addEventListener("change",(function(){e.Action=this.value})),s.appendChild(d);let r=document.createElement("td");r.classList.add("text-start");let c=document.createElement("span");c.classList.add("material-symbols-outlined"),c.innerHTML="link";let i=document.createElement("a");i.href="https://flare-explorer.flare.network/tx/"+e.hash,i.target="_blank",i.appendChild(c),i.appendChild(document.createTextNode(e.hash)),r.appendChild(i);let o=document.createElement("td");o.innerHTML=e.Volume,e.tokenSymbol&&o.classList.add(e.tokenSymbol);let l=document.createElement("td");l.innerHTML=e.Fee;let m=document.createElement("td");m.innerHTML=e.priceAverage;let u=document.createElement("td");e.FeeJPY=(e.Fee*e.priceAverage).toFixed(9),u.innerHTML=e.FeeJPY;let p=document.createElement("td");e.VolumeJPY=(e.Volume*e.priceAverage).toFixed(9),0!=e.VolumeJPY&&"Withdraw"!=e.Method&&"Deposit"!=e.Method||(e.VolumeJPY=0),p.innerHTML=e.VolumeJPY,t.appendChild(a),t.appendChild(n),t.appendChild(s),t.appendChild(r),t.appendChild(o),t.appendChild(l),t.appendChild(m),t.appendChild(u),t.appendChild(p),dataTable.prepend(t)}function timeJudge(e,t,a){return!t&&!a||(!!(t&&!a&&e>=t)||(!!(!t&&a&&e<=a)||!!(t&&a&&e>=t&&e<=a)))}function progress(e,t){let a=Math.ceil(e/t*100),n=a+"%";progressBar.setAttribute("aria-valuenow",a),progressBar.style.width=n,loadingPercent.innerHTML="100%"==n?"Complete.":n}function dlBtnActive(){dlbtnM.classList.remove("btn-secondary"),dlbtnM.classList.add("btn-warning"),dlbtnM.classList.remove("disabled"),dlbtn.classList.remove("btn-secondary"),dlbtn.classList.add("btn-warning"),dlbtn.classList.remove("disabled"),setTimeout((()=>{loading.classList.add("pre-load"),generate.classList.remove("btn-secondary"),generate.classList.add("btn-warning"),generate.classList.remove("disabled"),clearStartDate.classList.remove("btn-secondary"),clearStartDate.classList.add("btn-warning"),clearStartDate.classList.remove("disabled"),clearEndDate.classList.remove("btn-secondary"),clearEndDate.classList.add("btn-warning"),clearEndDate.classList.remove("disabled")}),1e3),setTimeout((()=>{progressBar.setAttribute("aria-valuenow","0"),progressBar.style.width="0%",loadingPercent.innerHTML="0%"}),1500)}function downloadCSVforCT(){let e=JSON.parse(JSON.stringify(targetTx)),t=[];e.forEach((e=>{const a={};csvSort.forEach((t=>{e.hasOwnProperty(t)&&(a[t]=e[t])})),t.push(a)})),csvDownload(t,"flr-csv-for-cryptact.csv")}function downloadCSVMore(){let e=JSON.parse(JSON.stringify(targetTx)),t=[];e.forEach((e=>{const a={};csvSortMore.forEach((t=>{e.hasOwnProperty(t)&&(a[t]=e[t])})),t.push(a)})),csvDownload(t,"flr-csv-more.csv")}function csvDownload(e,t){const a=Object.keys(e[0]).join(",")+"\n"+e.map((e=>Object.values(e).join(","))).join("\n"),n=new Blob([a],{type:"text/csv"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download=t,s.click(),s.remove()}function division10p18fixed9(e){let t=Number((e/1e9).toFixed(9));return Number((t/1e9).toFixed(9))}function convertToJapanDateTime(e,t){const a=new Date(e);"YMDHMS"==t?a.setHours(a.getHours()):"YMD"==t&&a.setHours(a.getHours()-9);const n=a.getFullYear(),s=(a.getMonth()+1).toString().padStart(2,"0"),d=a.getDate().toString().padStart(2,"0"),r=a.getHours().toString().padStart(2,"0"),c=a.getMinutes().toString().padStart(2,"0"),i=("0"+a.getSeconds()).slice(-2);return"YMDHMS"==t?`${n}-${s}-${d} ${r}:${c}:${i}`:"YMD"==t?`${n}${s}${d}`:void 0}function hexConvert(e){return parseInt(e,16)}function convertToUnixTime(e){return Math.floor(new Date(e).getTime()/1e3)}inputStartDate.addEventListener("change",(()=>{startDate()})),clearStartDate.addEventListener("click",(()=>{inputStartDate.value="",startDate()})),inputEndDate.addEventListener("change",(()=>{endDate()})),clearEndDate.addEventListener("click",(()=>{inputEndDate.value="",endDate()})),window.addEventListener("load",(async()=>{const e=new Web3(window.ethereum);connectWalletBtn.addEventListener("click",(async()=>{if(void 0!==window.ethereum)try{await window.ethereum.request({method:"eth_requestAccounts"});const t=(await e.eth.getAccounts())[0];inputWaddress.value=t}catch(e){alert("Failed to connect to wallet")}else alert("MetaMask is not installed!")}))}));